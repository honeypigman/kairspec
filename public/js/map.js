$(document).ready(function(){$(".marker").parent("div").on("mouseover",function(){$(this).css("z-index","999")}),$(".marker").parent("div").on("mouseleave",function(){$(this).css("z-index","-1")}),$(".marker").on("mouseover",function(){markerInfoDetail($(this))}),$(".marker").on("click",function(){markerInfoDetail($(this))}),$(".marker-pick").parent("div").css("z-index","-999"),$(document).on("click",".btnClose",function(a){$(".marker-pick").removeClass(),$(".markerDetail").html("")});let a=!1;$("#find-me").on("click",function(){a=!0;$(this).append("<div class='spinner-border spinner-border-sm img-center' role='status'><span class='visually-hidden'>Loading...</span></div> "),$(this).css("background-image",'url("")'),findStation()})});var initPoint=new naver.maps.LatLng(37.572025,127.005028),mapDiv=document.getElementById("map"),map=new naver.maps.Map(mapDiv,{center:initPoint,zoom:5});function markerInfoDetail(a){$(".markerDetail").append('<div id="markerDetail" class="alert alert-success d-none" role="alert" ><h4>[<span id="city">[시도명]</span>]<span id="stationName">[측정소명]</span></h4><div class="text-center"><h5><span class="badge bg-light text-dark w-100 mb-2" id="msg">[메세지]</span></h5></div><div class="row"><div class="col-9"><div class="text-start">미세먼지 <span id="pm10">[미세먼지]</span> ㎍/m³</div><div class="text-start">초미세먼지 <span id="pm25">[초미세먼지]</span> ㎍/m³</div></div><div class="col-3" style="margin-top:-8px; margin-left:-20px;"><img id="emoticonDetail" src="/img/grade0.png"></div></div><div class="markerReport"><canvas class="my-4 w-100 chartjs-render-monitor" id="myChart" height="290" style="display: block;"></canvas></div><button type="button" class="btn btn-light btn-sm w-100 btnClose" data-bs-dismiss="toast">닫기</button></div>');var t=$(a).find("span.date").data("date"),e=$(a).data("grade"),n=$(a).find("span.msg").data("msg"),s=$(a).find("span.pm10").data("pm10"),i=$(a).find("span.pm25").data("pm25"),r=$(a).find("span.city").data("city"),o=$(a).find("span.station").data("station");$(a).find("span.marker-bg").addClass("bg_"+e),$("#markerDetail").removeClass(),$("#markerDetail").addClass("alert alert-success d-block"),$("#markerDetail").addClass("bg_"+e),$("#msg").empty().text(n),$("#pm10").empty().text(s),$("#pm25").empty().text(i),$("#city").empty().text(r),$("#stationName").empty().text(o),$("#emoticonDetail").attr("src","/img/"+e+".png"),setChartStationTimeFlow(t,r,o)}function addMarker(a,t,e,n,s,i=0,r=0,o,d){var m="grade"+a,p=new naver.maps.LatLng(n,s),c={position:p,icon:{content:'<span class="marker '+m+'" data-grade="'+m+'"><span class="emoticon"></span><span class="pm10" data-pm10="'+i+'"></span><span class="pm25" data-pm25="'+r+'"></span><span class="station" data-station="'+d+'"></span><span class="city" data-city="'+o+'"></span><span class="msg" data-msg="'+t+'"></span><span class="date" data-date="'+e+'"></span><span class="marker-bg"></sapn></span>',size:new naver.maps.Size(27,34),origin:new naver.maps.Point(0,0),anchor:new naver.maps.Point(11,34)}},l=new naver.maps.Marker(c);l.setMap(map),naver.maps.Event.addListener(l,"click",function(){$(".marker-pick").removeClass(),zoomIn(p)})}function zoomIn(a){var t,e=map.getZoom(),n={position:a,icon:{content:'<span class="marker-pick"></span>',size:new naver.maps.Size(50,50),origin:new naver.maps.Point(0,0),anchor:new naver.maps.Point(11,34)}};new naver.maps.Marker(n).setMap(map),map.setCenter(a),t=12-e,map.zoomBy(t,a,!0)}function setChartStationTimeFlow(a,t,e){let n=[],s=[],i=[],r=a.substring(0,10);$.ajax({method:"GET",url:"/api/find/station/timeflow/"+r+"/"+t+"/"+e,dataType:"JSON",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},success:function(t){JSON.stringify(t);$.each(t,function(){n.push(this.time.substring(.2)),s.push(this.data.pm10),i.push(this.data.pm25)}),$("#myChart").remove(),$(".markerReport").append('<canvas class="my-4 w-100 chartjs-render-monitor" id="myChart" height="290" style="display: block;"></canvas>');var e={labels:n,datasets:[{label:"미세",borderColor:"rgba(255, 206, 86)",backgroundColor:"rgba(255, 206, 86)",fill:!1,data:s,yAxisID:"y-axis-1"},{label:"초미세",borderColor:"rgba(255, 99, 132)",backgroundColor:"rgba(255, 99, 132)",fill:!1,data:i,yAxisID:"y-axis-2"}]},r=document.getElementById("myChart").getContext("2d");new Chart(r,{type:"line",data:e,options:{title:{display:!0,text:a},responsive:!0,hoverMode:"index",stacked:!1,scales:{yAxes:[{type:"linear",display:!0,position:"left",id:"y-axis-1"},{type:"linear",display:!0,position:"right",id:"y-axis-2",gridLines:{drawOnChartArea:!1}}]}}})},error:function(a){console.log("SetChartStationTimeFlow Error>"+a)}})}function findStation(a="AUTO",t=null,e=null){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(n){"AUTO"==a&&(t=n.coords.latitude,e=n.coords.longitude),$("#find-me").text(""),$("#find-me").css("background-image",'url("/img/point.png")'),$.ajax({method:"GET",url:"/api/find/station/"+t+"/"+e,dataType:"JSON",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},success:function(a){if(a.mesure_date){var n=a.mesure_date,s=a.grade,i=a.msg,r=a.city,o=a.stationName,d=a.mesure_pm10,m=a.mesure_pm25;$(".markerDetail").empty(),$(".markerDetail").append('<div id="markerDetail" class="alert alert-success d-block" role="alert" ><h4>[<span id="city">[시도명]</span>]<span id="stationName">[측정소명]</span></h4><div class="text-center"><h5><span class="badge bg-light text-dark w-100 mb-2" id="msg">[메세지]</span></h5></div><div class="row"><div class="col-9"><div class="text-start">미세먼지 <span id="pm10">[미세먼지]</span> ㎍/m³</div><div class="text-start">초미세먼지 <span id="pm25">[초미세먼지]</span> ㎍/m³</div></div><div class="col-3" style="margin-top:-8px; margin-left:-20px;"><img id="emoticonDetail" src="/img/grade0.png"></div></div><div class="markerReport"><canvas class="my-4 w-100 chartjs-render-monitor" id="myChart" height="290" style="display: block;"></canvas></div><button type="button" class="btn btn-light btn-sm w-100 btnClose" data-bs-dismiss="toast">닫기</button></div>'),$("#markerDetail").addClass("bg_grade"+s),$("#msg").empty().text(i),$("#pm10").empty().text(d),$("#pm25").empty().text(m),$("#city").empty().text(r),$("#stationName").empty().text(o),$("#emoticonDetail").attr("src","/img/grade"+s+".png"),new naver.maps.Marker({map:map,position:new naver.maps.LatLng(t,e)}),new naver.maps.Polyline({map:map,path:[new naver.maps.LatLng(t,e),new naver.maps.LatLng(a.dmX,a.dmY)],strokeColor:"#5347AA",strokeStyle:"longdash",strokeOpacity:.5,strokeWeight:2}),setChartStationTimeFlow(n,r,o),zoomIn(new naver.maps.LatLng(a.dmX,a.dmY)),click=!0}},error:function(a){console.log("FindStation Error>"+a),click=!1}})},function(){alert("ERR>Unable to retrieve your location."),click=!1})}var infoWindow=new naver.maps.InfoWindow({anchorSkew:!0});function searchAddressToCoordinate(a){naver.maps.Service.geocode({query:a},function(a,t){naver.maps.Service.Status.ERROR,0===t.v2.meta.totalCount&&setAlert("검색한 주소 정보가 존재하지 않습니다!");var e=t.v2.addresses[0];new naver.maps.Point(e.x,e.y);findStation("SEARCH",e.y,e.x)})}function initGeocoder(){map.isStyleMapReady&&($("#address").on("keydown",function(a){13===a.which&&searchAddressToCoordinate($("#address").val())}),$("#submit").on("click",function(a){if(!$("#address").val())return setAlert("검색할 주소 정보를 입력해주세요."),$("#address").focus(),!1;a.preventDefault(),searchAddressToCoordinate($("#address").val())}))}function setAlert(a){$("#search-alert").removeClass("d-none"),$("#search-alert-msg").text(a),setInterval(function(){$("#search-alert").addClass("d-none"),$("#search-alert-msg").empty()},3e3)}map.setCursor("pointer"),naver.maps.onJSContentLoaded=initGeocoder,naver.maps.Event.once(map,"init_stylemap",initGeocoder);
