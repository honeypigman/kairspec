$(document).ready(function(){$(".marker").parent("div").on("mouseover",function(){$(this).css("z-index","999")}),$(".marker").parent("div").on("mouseleave",function(){$(this).css("z-index","-1")}),$(".marker").on("mouseover",function(){markerInfoDetail($(this))}),$(".marker").on("click",function(){markerInfoDetail($(this))}),$(document).on("click",".btnClose",function(a){$(".markerDetail").html("")});let a=!1;$("#find-me").on("click",function(){a=!0;$(this).append("<div class='spinner-border spinner-border-sm img-center' role='status'><span class='visually-hidden'>Loading...</span></div> "),$(this).css("background-image",'url("")'),findStation()})});var initPoint=new naver.maps.LatLng(37.572025,127.005028),mapDiv=document.getElementById("map"),map=new naver.maps.Map(mapDiv,{center:initPoint,zoom:5});function markerInfoDetail(a){$(".markerDetail").append('<div id="markerDetail" class="alert alert-success d-none" role="alert" ><h4>[<span id="city">[시도명]</span>]<span id="stationName">[측정소명]</span></h4><div class="text-center"><h5><span class="badge bg-light text-dark w-100 mb-2" id="msg">[메세지]</span></h5></div><div class="row"><div class="col-9"><div class="text-start">미세먼지 <span id="pm10">[미세먼지]</span> ㎍/m³</div><div class="text-start">초미세먼지 <span id="pm25">[초미세먼지]</span> ㎍/m³</div></div><div class="col-3" style="margin-top:-8px; margin-left:-20px;"><img id="emoticonDetail" src="/img/grade0.png"></div></div><div class="markerReport"><canvas class="my-4 w-100 chartjs-render-monitor" id="myChart" height="290" style="display: block;"></canvas></div><button type="button" class="btn btn-light btn-sm w-100 btnClose" data-bs-dismiss="toast">닫기</button></div>');var e=$(a).find("span.date").data("date"),t=$(a).data("grade"),n=$(a).find("span.msg").data("msg"),s=$(a).find("span.pm10").data("pm10"),i=$(a).find("span.pm25").data("pm25"),r=$(a).find("span.city").data("city"),o=$(a).find("span.station").data("station");$(a).find("span.marker-bg").addClass("bg_"+t),$("#markerDetail").removeClass(),$("#markerDetail").addClass("alert alert-success d-block"),$("#markerDetail").addClass("bg_"+t),$("#msg").empty().text(n),$("#pm10").empty().text(s),$("#pm25").empty().text(i),$("#city").empty().text(r),$("#stationName").empty().text(o),$("#emoticonDetail").attr("src","/img/"+t+".png"),setChartStationTimeFlow(e,r,o)}function addMarker(a,e,t,n,s,i=0,r=0,o,d){var m="grade"+a,l=new naver.maps.LatLng(n,s),c={position:l,icon:{content:'<span class="marker '+m+'" data-grade="'+m+'"><span class="emoticon"></span><span class="pm10" data-pm10="'+i+'"></span><span class="pm25" data-pm25="'+r+'"></span><span class="station" data-station="'+d+'"></span><span class="city" data-city="'+o+'"></span><span class="msg" data-msg="'+e+'"></span><span class="date" data-date="'+t+'"></span><span class="marker-bg"></sapn></span>',size:new naver.maps.Size(27,34),origin:new naver.maps.Point(0,0),anchor:new naver.maps.Point(11,34)}},p=new naver.maps.Marker(c);p.setMap(map),naver.maps.Event.addListener(p,"click",function(){zoomIn(l)})}function zoomIn(a){var e,t=map.getZoom();map.setCenter(a),e=13-t,map.zoomBy(e,a,!0)}function setChartStationTimeFlow(a,e,t){let n=[],s=[],i=[],r=a.substring(0,10);$.ajax({method:"GET",url:"/api/find/station/timeflow/"+r+"/"+e+"/"+t,dataType:"JSON",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},success:function(e){JSON.stringify(e);$.each(e,function(){n.push(this.time.substring(.2)),s.push(this.data.pm10),i.push(this.data.pm25)}),$("#myChart").remove(),$(".markerReport").append('<canvas class="my-4 w-100 chartjs-render-monitor" id="myChart" height="290" style="display: block;"></canvas>');var t={labels:n,datasets:[{label:"미세",borderColor:"rgba(255, 206, 86)",backgroundColor:"rgba(255, 206, 86)",fill:!1,data:s,yAxisID:"y-axis-1"},{label:"초미세",borderColor:"rgba(255, 99, 132)",backgroundColor:"rgba(255, 99, 132)",fill:!1,data:i,yAxisID:"y-axis-2"}]},r=document.getElementById("myChart").getContext("2d");new Chart(r,{type:"line",data:t,options:{title:{display:!0,text:a},responsive:!0,hoverMode:"index",stacked:!1,scales:{yAxes:[{type:"linear",display:!0,position:"left",id:"y-axis-1"},{type:"linear",display:!0,position:"right",id:"y-axis-2",gridLines:{drawOnChartArea:!1}}]}}})},error:function(a){console.log("SetChartStationTimeFlow Error>"+a)}})}function findStation(a="AUTO",e=null,t=null){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(n){"AUTO"==a&&(e=n.coords.latitude,t=n.coords.longitude),console.log(e+"//"+t),$("#find-me").text(""),$("#find-me").css("background-image",'url("/img/point.png")'),$.ajax({method:"GET",url:"/api/find/station/"+e+"/"+t,dataType:"JSON",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},success:function(a){if(console.log(a),a.mesure_date){var e=a.mesure_date,t=a.grade,n=a.msg,s=a.city,i=a.stationName,r=a.mesure_pm10,o=a.mesure_pm25;$("#markerDetail").removeClass(),$("#markerDetail").addClass("alert alert-success d-block"),$("#markerDetail").addClass("bg_grade"+t),$("#msg").empty().text(n),$("#pm10").empty().text(r),$("#pm25").empty().text(o),$("#city").empty().text(s),$("#stationName").empty().text(i),$("#emoticonDetail").attr("src","/img/grade"+t+".png"),setChartStationTimeFlow(e,s,i),zoomIn(new naver.maps.LatLng(a.dmX,a.dmY)),click=!0}},error:function(a){console.log("FindStation Error>"+a),click=!1}})},function(){alert("ERR>Unable to retrieve your location."),click=!1})}var infoWindow=new naver.maps.InfoWindow({anchorSkew:!0});function searchAddressToCoordinate(a){naver.maps.Service.geocode({query:a},function(e,t){if(console.log(e),console.log(t),e===naver.maps.Service.Status.ERROR)return a?alert("Geocode Error, address:"+a):alert("Geocode Error, Please check address");if(0===t.v2.meta.totalCount)return alert("No result.");var n=[],s=t.v2.addresses[0],i=new naver.maps.Point(s.x,s.y);s.roadAddress&&n.push("[도로명 주소] "+s.roadAddress),s.jibunAddress&&n.push("[지번 주소] "+s.jibunAddress),s.englishAddress&&n.push("[영문명 주소] "+s.englishAddress),zoomIn(i)})}function initGeocoder(){map.isStyleMapReady&&($("#address").on("keydown",function(a){13===a.which&&searchAddressToCoordinate($("#address").val())}),$("#submit").on("click",function(a){a.preventDefault(),searchAddressToCoordinate($("#address").val())}))}map.setCursor("pointer"),naver.maps.onJSContentLoaded=initGeocoder,naver.maps.Event.once(map,"init_stylemap",initGeocoder);
